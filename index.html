<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Serenity Studio â€” Meditation Video Generator</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Jost:wght@200;300;400;500&display=swap" rel="stylesheet">

<!-- PWA -->

<link rel="manifest" href="#" id="manifestLink">
<meta name="theme-color" content="#0d0e14">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Serenity Studio">
<meta name="description" content="Create beautiful meditation videos with ambient music and stunning visuals.">
<!-- PWA icons (inline SVG as data URI) -->
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='80' fill='%230d0e14'/%3E%3Ccircle cx='256' cy='256' r='140' fill='none' stroke='%238b8fd8' stroke-width='8' opacity='0.6'/%3E%3Ccircle cx='256' cy='256' r='90' fill='none' stroke='%234db8b8' stroke-width='5' opacity='0.5'/%3E%3Ccircle cx='256' cy='256' r='45' fill='%238b8fd8' opacity='0.7'/%3E%3C/svg%3E">
<style>
:root {
  --ink: #0d0e14;
  --deep: #111320;
  --surface: #171926;
  --panel: #1c2030;
  --border: #252a3d;
  --mist: #2e3450;
  --text: #cdd3f0;
  --soft: #7b83a8;
  --moon: #e8dfc8;
  --gold: #c4a55a;
  --lavender: #8b8fd8;
  --rose: #c07ba0;
  --teal: #4db8b8;
  --glow: rgba(139,143,216,0.15);
}

*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

html { font-size: 14px; }

body {
background: var(â€“ink);
color: var(â€“text);
font-family: â€˜Jostâ€™, sans-serif;
font-weight: 300;
min-height: 100vh;
overflow-x: hidden;
}

/* GRAIN overlay */
body::after {
content:â€™â€™;
position:fixed; inset:0;
background-image: url(â€œdata:image/svg+xml,%3Csvg xmlns=â€˜http://www.w3.org/2000/svgâ€™ width=â€˜300â€™ height=â€˜300â€™%3E%3Cfilter id=â€˜nâ€™%3E%3CfeTurbulence type=â€˜fractalNoiseâ€™ baseFrequency=â€˜0.75â€™ numOctaves=â€˜4â€™ stitchTiles=â€˜stitchâ€™/%3E%3C/filter%3E%3Crect width=â€˜300â€™ height=â€˜300â€™ filter=â€˜url(%23n)â€™ opacity=â€˜0.03â€™/%3E%3C/svg%3Eâ€);
pointer-events:none; z-index:999;
}

/* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app { display:grid; grid-template-columns:340px 1fr; grid-template-rows:auto 1fr; min-height:100vh; }

.topbar {
grid-column: 1/-1;
padding: 18px 32px;
display: flex; align-items:center; justify-content:space-between;
border-bottom: 1px solid var(â€“border);
background: linear-gradient(180deg, rgba(13,14,20,0.95), rgba(17,19,32,0.9));
backdrop-filter: blur(12px);
position: sticky; top:0; z-index:50;
}

.logo {
display:flex; align-items:baseline; gap:10px;
}
.logo-mark {
font-family: â€˜Cormorant Garamondâ€™, serif;
font-size: 22px; font-weight:300; font-style:italic;
color: var(â€“moon);
letter-spacing: 1px;
}
.logo-tag {
font-size: 9px; letter-spacing:3px; text-transform:uppercase;
color: var(â€“soft); font-weight:400;
}

.topbar-actions { display:flex; gap:10px; align-items:center; }

.sidebar {
grid-column:1; grid-row:2;
background: var(â€“deep);
border-right: 1px solid var(â€“border);
overflow-y: auto;
padding: 0 0 40px;
}

.main {
grid-column:2; grid-row:2;
display:flex; flex-direction:column;
padding: 28px 32px;
gap: 20px;
overflow-y: auto;
}

/* â”€â”€ SIDEBAR SECTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar-section {
padding: 20px 22px;
border-bottom: 1px solid var(â€“border);
}

.sidebar-section:last-child { border-bottom:none; }

.sec-label {
font-size: 9px; letter-spacing:3px; text-transform:uppercase;
color: var(â€“soft); margin-bottom:14px; font-weight:400;
display:flex; align-items:center; gap:8px;
}
.sec-label::after {
content:â€™â€™; flex:1; height:1px; background:var(â€“border);
}

/* â”€â”€ CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.control-row { display:flex; flex-direction:column; gap:6px; margin-bottom:14px; }
.control-row:last-child { margin-bottom:0; }

label { font-size:11px; color:var(â€“soft); font-weight:400; letter-spacing:0.5px; }

input[type=range] {
-webkit-appearance:none; width:100%; height:3px;
background: var(â€“mist); border-radius:3px; outline:none;
cursor:pointer;
}
input[type=range]::-webkit-slider-thumb {
-webkit-appearance:none; width:14px; height:14px;
background: var(â€“lavender); border-radius:50%;
box-shadow: 0 0 8px rgba(139,143,216,0.5);
}

select {
background: var(â€“surface); color:var(â€“text);
border:1px solid var(â€“border); border-radius:6px;
padding:8px 10px; font-family:â€˜Jostâ€™,sans-serif;
font-size:12px; outline:none; width:100%; cursor:pointer;
}
select:focus { border-color:var(â€“lavender); }

input[type=text], textarea {
background: var(â€“surface); color:var(â€“text);
border:1px solid var(â€“border); border-radius:6px;
padding:8px 10px; font-family:â€˜Jostâ€™,sans-serif;
font-size:12px; outline:none; width:100%; resize:vertical;
}
input[type=text]:focus, textarea:focus { border-color:var(â€“lavender); }

input[type=color] {
-webkit-appearance:none; width:32px; height:28px;
border:1px solid var(â€“border); border-radius:5px;
background:none; cursor:pointer; padding:2px;
}

.color-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.color-swatch-label { font-size:11px; color:var(â€“soft); }

.toggle-group { display:flex; gap:6px; flex-wrap:wrap; }
.toggle-btn {
font-size:10px; letter-spacing:1px; text-transform:uppercase;
padding:5px 12px; border-radius:20px; border:1px solid var(â€“border);
background:transparent; color:var(â€“soft); cursor:pointer;
transition:all 0.2s; font-family:â€˜Jostâ€™,sans-serif; font-weight:400;
}
.toggle-btn.active {
background:var(â€“lavender); border-color:var(â€“lavender);
color:var(â€“ink);
}
.toggle-btn:hover:not(.active) { border-color:var(â€“lavender); color:var(â€“lavender); }

.val-display { font-size:11px; color:var(â€“lavender); font-family:monospace; }

/* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
font-family:â€˜Jostâ€™,sans-serif; font-weight:400; font-size:11px;
letter-spacing:1.5px; text-transform:uppercase;
padding:10px 20px; border-radius:6px; border:none;
cursor:pointer; transition:all 0.25s; display:inline-flex;
align-items:center; gap:7px; white-space:nowrap;
}
.btn-primary {
background: linear-gradient(135deg, var(â€“lavender), #6d72c9);
color:#fff; box-shadow:0 4px 20px rgba(139,143,216,0.3);
}
.btn-primary:hover { transform:translateY(-1px); box-shadow:0 6px 28px rgba(139,143,216,0.45); }
.btn-ghost {
background:transparent; border:1px solid var(â€“border);
color:var(â€“soft);
}
.btn-ghost:hover { border-color:var(â€“soft); color:var(â€“text); }
.btn-gold {
background: linear-gradient(135deg, var(â€“gold), #a8873a);
color:var(â€“ink); font-weight:500;
}
.btn-gold:hover { transform:translateY(-1px); box-shadow:0 6px 24px rgba(196,165,90,0.35); }
.btn-danger {
background:transparent; border:1px solid #c07070; color:#c07070;
}
.btn-danger:hover { background:rgba(192,112,112,0.1); }
.btn:disabled { opacity:0.4; cursor:not-allowed; transform:none !important; }

/* â”€â”€ PREVIEW AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.preview-wrap {
background: var(â€“panel);
border:1px solid var(â€“border); border-radius:14px;
overflow:hidden; position:relative;
aspect-ratio: 16/9; width:100%;
}

#previewCanvas {
width:100%; height:100%;
display:block;
}

.preview-overlay-ui {
position:absolute; inset:0;
display:flex; flex-direction:column;
justify-content:space-between; padding:16px;
pointer-events:none;
background: linear-gradient(180deg, rgba(0,0,0,0.3) 0%, transparent 30%, transparent 70%, rgba(0,0,0,0.4) 100%);
}

.preview-topbar {
display:flex; justify-content:space-between; align-items:center;
}

.rec-badge {
background:rgba(255,60,60,0.85); color:#fff;
font-size:9px; letter-spacing:2px; padding:3px 9px;
border-radius:20px; font-weight:500;
animation: recpulse 1.5s ease-in-out infinite;
display:none;
}
.rec-badge.visible { display:block; }

@keyframes recpulse { 0%,100%{opacity:1} 50%{opacity:0.5} }

.preview-timer {
font-family: monospace; font-size:12px; color:rgba(255,255,255,0.7);
}

.preview-bottom { display:flex; flex-direction:column; gap:6px; }
.preview-title-display {
font-family:â€˜Cormorant Garamondâ€™,serif; font-style:italic;
font-size:clamp(14px,2vw,22px); color:rgba(255,255,255,0.9);
text-shadow:0 2px 12px rgba(0,0,0,0.8);
}
.preview-subtitle-display {
font-size:clamp(9px,1.2vw,12px); color:rgba(255,255,255,0.55);
letter-spacing:2px; text-transform:uppercase;
}

/* Progress bar */
.render-progress {
display:none; flex-direction:column; gap:8px;
}
.render-progress.visible { display:flex; }
.progress-track {
height:3px; background:var(â€“mist); border-radius:3px; overflow:hidden;
}
.progress-fill {
height:100%; background:linear-gradient(90deg,var(â€“lavender),var(â€“teal));
border-radius:3px; transition:width 0.3s ease; width:0%;
}
.progress-label { font-size:11px; color:var(â€“soft); }

/* â”€â”€ INFO PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.info-grid {
display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;
}
.info-card {
background:var(â€“panel); border:1px solid var(â€“border);
border-radius:10px; padding:14px; text-align:center;
}
.info-card-val {
font-family:â€˜Cormorant Garamondâ€™,serif; font-size:22px;
color:var(â€“moon); font-weight:300; margin-bottom:3px;
}
.info-card-key { font-size:9px; color:var(â€“soft); letter-spacing:2px; text-transform:uppercase; }

/* â”€â”€ SCRIPT AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.script-panel {
background:var(â€“panel); border:1px solid var(â€“border);
border-radius:12px; padding:20px;
}
.script-panel h3 {
font-family:â€˜Cormorant Garamondâ€™,serif; font-size:16px;
font-weight:300; color:var(â€“moon); margin-bottom:12px;
}

.action-row {
display:flex; gap:10px; flex-wrap:wrap; align-items:center;
}

/* â”€â”€ YOUTUBE PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.yt-panel {
background: linear-gradient(135deg, rgba(255,0,0,0.04), rgba(17,19,32,0));
border:1px solid rgba(255,80,80,0.2); border-radius:12px;
padding:20px;
}
.yt-panel h3 {
font-family:â€˜Cormorant Garamondâ€™,serif; font-size:16px;
font-weight:300; color:#ff8080; margin-bottom:4px;
display:flex; align-items:center; gap:8px;
}
.yt-panel p { font-size:11px; color:var(â€“soft); margin-bottom:14px; line-height:1.6; }

.yt-form { display:flex; flex-direction:column; gap:10px; }
.yt-form input, .yt-form textarea, .yt-form select {
background:rgba(255,255,255,0.04);
}

.yt-status {
font-size:11px; padding:8px 12px; border-radius:6px;
display:none;
}
.yt-status.info { display:block; background:rgba(139,143,216,0.1); color:var(â€“lavender); border:1px solid rgba(139,143,216,0.2); }
.yt-status.success { display:block; background:rgba(77,184,184,0.1); color:var(â€“teal); border:1px solid rgba(77,184,184,0.2); }
.yt-status.error { display:block; background:rgba(192,112,112,0.1); color:#e08080; border:1px solid rgba(192,112,112,0.2); }

/* â”€â”€ AUDIO UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.drop-zone {
border:1px dashed var(â€“border); border-radius:8px;
padding:20px; text-align:center; cursor:pointer;
transition:all 0.2s; position:relative;
}
.drop-zone:hover, .drop-zone.dragover {
border-color:var(â€“lavender); background:rgba(139,143,216,0.05);
}
.drop-zone input { position:absolute; inset:0; opacity:0; cursor:pointer; }
.drop-zone-text { font-size:11px; color:var(â€“soft); line-height:1.6; }
.drop-zone-text strong { color:var(â€“lavender); }
.uploaded-file {
font-size:11px; color:var(â€“teal); margin-top:6px;
display:none; align-items:center; gap:6px;
}
.uploaded-file.visible { display:flex; }

/* â”€â”€ SCROLLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width:4px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(â€“mist); border-radius:2px; }

/* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:900px) {
.app { grid-template-columns:1fr; }
.sidebar { grid-column:1; grid-row:3; border-right:none; border-top:1px solid var(â€“border); }
.main { grid-column:1; grid-row:2; }
.info-grid { grid-template-columns:1fr 1fr; }
}

/* Ko-fi button */
.kofi-btn {
background: linear-gradient(135deg, #ff5e5b, #ff8c42);
color: #fff !important;
text-decoration: none;
font-weight: 400;
box-shadow: 0 4px 16px rgba(255,94,91,0.3);
animation: kofi-glow 3s ease-in-out infinite;
}
.kofi-btn:hover { transform:translateY(-1px); box-shadow:0 6px 24px rgba(255,94,91,0.5); }

@keyframes kofi-glow {
0%,100% { box-shadow: 0 4px 16px rgba(255,94,91,0.3); }
50% { box-shadow: 0 4px 24px rgba(255,94,91,0.55); }
}

/* Watermark toggle */
.watermark-row {
display: flex; align-items: center; justify-content: space-between;
padding: 10px 0; border-top: 1px solid var(â€“border); margin-top: 8px;
}
.watermark-label { font-size:11px; color:var(â€“soft); line-height:1.5; }
.watermark-label span { display:block; color: var(â€“gold); font-size:9px; letter-spacing:1.5px; text-transform:uppercase; margin-top:2px; }

.toggle-switch {
position: relative; width: 36px; height: 20px; flex-shrink:0;
}
.toggle-switch input { opacity:0; width:0; height:0; }
.toggle-slider {
position:absolute; inset:0; background:var(â€“mist);
border-radius:20px; cursor:pointer; transition:0.3s;
}
.toggle-slider::before {
content:â€™â€™; position:absolute;
width:14px; height:14px; left:3px; bottom:3px;
background:#fff; border-radius:50%; transition:0.3s;
}
.toggle-switch input:checked + .toggle-slider { background: var(â€“gold); }
.toggle-switch input:checked + .toggle-slider::before { transform:translateX(16px); }
</style>

</head>
<body>
<div class="app">

  <!-- â”€â”€ TOP BAR â”€â”€ -->

  <header class="topbar">
    <div class="logo">
      <span class="logo-mark">Serenity Studio</span>
      <span class="logo-tag">Meditation Video Generator</span>
    </div>
    <div class="topbar-actions">
      <a href="https://ko-fi.com" target="_blank" class="btn kofi-btn" id="kofiBtn" title="Support this app on Ko-fi â˜•">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M23.881 8.948c-.773-4.085-4.859-4.593-4.859-4.593H.723c-.604 0-.679.798-.679.798s-.082 5.647.08 8.262c.164 2.616 2.476 2.764 2.476 2.764 1.455.075 3.415-.162 4.777-.193l.025 1.755c0 .297.096.478.096.478.19.281.646.297.646.297h3.81c.443-.016.557-.297.557-.297.236-.562.236-1.914.236-1.914 1.41.017 5.369.137 6.09-2.504.718-2.642-.06-4.847-.06-4.847zm-3.557 3.087c-.41 2.054-4.179 1.645-5.498 1.607l-.028-3.25c1.363.03 5.936-.458 5.526 1.643zM9.043 3.607c-.59 0-1.067.477-1.067 1.066 0 .591.478 1.067 1.067 1.067.59 0 1.067-.476 1.067-1.067 0-.589-.477-1.066-1.067-1.066zm3.213 0c-.59 0-1.067.477-1.067 1.066 0 .591.477 1.067 1.067 1.067s1.066-.476 1.066-1.067c0-.589-.476-1.066-1.066-1.066z"/></svg>
        Support â˜•
      </a>
      <button class="btn btn-ghost" id="installBtn" style="display:none; border-color:var(--gold); color:var(--gold);">â¬‡ Install App</button>
      <button class="btn btn-ghost" id="previewBtn">â–¶ Preview</button>
      <button class="btn btn-primary" id="renderBtn">â¬‡ Render Video</button>
    </div>
  </header>

  <!-- â”€â”€ SIDEBAR â”€â”€ -->

  <aside class="sidebar">

```
<!-- SCENE -->
<div class="sidebar-section">
  <div class="sec-label">Visual Scene</div>
  <div class="control-row">
    <label>Style</label>
    <select id="sceneStyle">
      <option value="particles">âœ¦ Floating Particles & Light</option>
      <option value="mandala">â— Sacred Geometry / Mandala</option>
      <option value="nature">ã€° Flowing Water / Nature</option>
      <option value="cosmos">âœ§ Deep Cosmos / Nebula</option>
      <option value="breath">â—‰ Breathing Circle</option>
    </select>
  </div>
  <div class="control-row">
    <label>Color Palette</label>
    <div class="toggle-group" id="paletteGroup">
      <button class="toggle-btn active" data-palette="midnight">Midnight</button>
      <button class="toggle-btn" data-palette="aurora">Aurora</button>
      <button class="toggle-btn" data-palette="dusk">Dusk</button>
      <button class="toggle-btn" data-palette="forest">Forest</button>
      <button class="toggle-btn" data-palette="custom">Custom</button>
    </div>
  </div>
  <div class="control-row" id="customColors" style="display:none">
    <div class="color-row">
      <span class="color-swatch-label">BG</span>
      <input type="color" id="colorBg" value="#050a1a">
      <span class="color-swatch-label">Primary</span>
      <input type="color" id="colorPrimary" value="#8b8fd8">
      <span class="color-swatch-label">Accent</span>
      <input type="color" id="colorAccent" value="#4db8b8">
    </div>
  </div>
  <div class="control-row">
    <label>Motion Speed <span class="val-display" id="speedVal">0.4</span></label>
    <input type="range" id="motionSpeed" min="0.1" max="1" step="0.05" value="0.4">
  </div>
  <div class="control-row">
    <label>Particle Density / Complexity <span class="val-display" id="densityVal">60</span></label>
    <input type="range" id="density" min="10" max="120" step="5" value="60">
  </div>
  <div class="control-row">
    <label>Bloom / Glow Intensity <span class="val-display" id="bloomVal">0.6</span></label>
    <input type="range" id="bloom" min="0" max="1" step="0.05" value="0.6">
  </div>
</div>

<!-- TEXT OVERLAY -->
<div class="sidebar-section">
  <div class="sec-label">Text Overlay</div>
  <div class="control-row">
    <label>Video Title</label>
    <input type="text" id="videoTitle" value="Deep Sleep Meditation" placeholder="Your video titleâ€¦">
  </div>
  <div class="control-row">
    <label>Subtitle / Channel Tag</label>
    <input type="text" id="videoSubtitle" value="10 Hours Â· Relaxing Music for Deep Sleep" placeholder="Subtitleâ€¦">
  </div>
  <div class="control-row">
    <label>Title fade-in after (seconds) <span class="val-display" id="titleFadeVal">3</span></label>
    <input type="range" id="titleFade" min="0" max="30" step="1" value="3">
  </div>
  <div class="control-row">
    <label>Text Opacity <span class="val-display" id="textOpacityVal">0.85</span></label>
    <input type="range" id="textOpacity" min="0" max="1" step="0.05" value="0.85">
  </div>
</div>

<!-- AUDIO -->
<div class="sidebar-section">
  <div class="sec-label">Audio</div>
  <div class="control-row">
    <label>Music Source</label>
    <div class="toggle-group" id="musicSourceGroup">
      <button class="toggle-btn active" data-source="procedural">Generated</button>
      <button class="toggle-btn" data-source="upload">Upload</button>
    </div>
  </div>

  <!-- Procedural -->
  <div id="proceduralPanel">
    <div class="control-row">
      <label>Ambient Type</label>
      <select id="ambientType">
        <option value="sleep">Deep Sleep (Delta Waves)</option>
        <option value="theta">Theta Meditation (4-8Hz)</option>
        <option value="binauralAlpha">Alpha Relaxation (8-13Hz)</option>
        <option value="528hz">528Hz Love / Healing</option>
        <option value="rain">Rain & Thunder</option>
        <option value="bowl">Singing Bowl</option>
      </select>
    </div>
    <div class="control-row">
      <label>Base Tone (Hz) <span class="val-display" id="baseToneVal">432</span></label>
      <input type="range" id="baseTone" min="100" max="1000" step="1" value="432">
    </div>
    <div class="control-row">
      <label>Binaural Beat Offset (Hz) <span class="val-display" id="binauralVal">3.0</span></label>
      <input type="range" id="binauralBeat" min="0.5" max="40" step="0.5" value="3">
    </div>
    <div class="control-row">
      <label>Reverb / Depth <span class="val-display" id="reverbVal">0.7</span></label>
      <input type="range" id="reverbDepth" min="0" max="1" step="0.05" value="0.7">
    </div>
    <div class="control-row">
      <label>Low-pass Warmth <span class="val-display" id="warmthVal">800</span>Hz</label>
      <input type="range" id="warmth" min="200" max="5000" step="50" value="800">
    </div>
    <button class="btn btn-ghost" id="testAudioBtn" style="width:100%;justify-content:center;margin-top:6px;">â–¶ Test Audio (10s)</button>
  </div>

  <!-- Upload -->
  <div id="uploadPanel" style="display:none">
    <div class="drop-zone" id="dropZone">
      <input type="file" id="audioUpload" accept="audio/*">
      <div class="drop-zone-text">
        <strong>Click or drag</strong> an audio file<br>
        MP3, WAV, OGG, FLAC supported
      </div>
    </div>
    <div class="uploaded-file" id="uploadedFile">
      â™ª <span id="uploadedFileName">audio.mp3</span>
    </div>
    <div class="control-row" style="margin-top:10px">
      <label>Volume <span class="val-display" id="uploadVolVal">0.8</span></label>
      <input type="range" id="uploadVol" min="0" max="1" step="0.05" value="0.8">
    </div>
  </div>

  <div class="control-row" style="margin-top:10px">
    <label>Fade In (s) <span class="val-display" id="fadeInVal">5</span></label>
    <input type="range" id="fadeIn" min="0" max="30" step="1" value="5">
  </div>
  <div class="control-row">
    <label>Fade Out (s) <span class="val-display" id="fadeOutVal">10</span></label>
    <input type="range" id="fadeOut" min="0" max="60" step="1" value="10">
  </div>
</div>

<!-- DURATION -->
<div class="sidebar-section">
  <div class="sec-label">Export Settings</div>
  <div class="control-row">
    <label>Duration</label>
    <div class="toggle-group" id="durationGroup">
      <button class="toggle-btn" data-dur="60">1m</button>
      <button class="toggle-btn active" data-dur="600">10m</button>
      <button class="toggle-btn" data-dur="3600">1h</button>
      <button class="toggle-btn" data-dur="36000">10h</button>
    </div>
  </div>
  <div class="control-row">
    <label>Resolution</label>
    <select id="resolution">
      <option value="1080">1080p (1920Ã—1080)</option>
      <option value="720" selected>720p (1280Ã—720)</option>
      <option value="480">480p (854Ã—480)</option>
    </select>
  </div>
  <div class="control-row">
    <label>Frame Rate</label>
    <select id="framerate">
      <option value="30" selected>30 fps</option>
      <option value="24">24 fps</option>
      <option value="60">60 fps</option>
    </select>
  </div>
  <div class="control-row">
    <label>Video Quality</label>
    <select id="quality">
      <option value="high">High (slower render)</option>
      <option value="medium" selected>Medium (balanced)</option>
      <option value="fast">Fast (preview quality)</option>
    </select>
  </div>

  <!-- Watermark -->
  <div class="watermark-row">
    <div class="watermark-label">
      "Made with Serenity Studio" watermark
      <span>âœ¦ Helps grow the app for free</span>
    </div>
    <label class="toggle-switch">
      <input type="checkbox" id="watermarkToggle" checked>
      <span class="toggle-slider"></span>
    </label>
  </div>

</div>
```

  </aside>

  <!-- â”€â”€ MAIN AREA â”€â”€ -->

  <main class="main">

```
<!-- Info strip -->
<div class="info-grid">
  <div class="info-card">
    <div class="info-card-val" id="infoScene">Particles</div>
    <div class="info-card-key">Visual Style</div>
  </div>
  <div class="info-card">
    <div class="info-card-val" id="infoDuration">10m</div>
    <div class="info-card-key">Duration</div>
  </div>
  <div class="info-card">
    <div class="info-card-val" id="infoRes">720p</div>
    <div class="info-card-key">Resolution</div>
  </div>
</div>

<!-- Preview canvas -->
<div class="preview-wrap">
  <canvas id="previewCanvas"></canvas>
  <div class="preview-overlay-ui">
    <div class="preview-topbar">
      <div class="rec-badge" id="recBadge">â— REC</div>
      <div class="preview-timer" id="previewTimer">00:00</div>
    </div>
    <div class="preview-bottom">
      <div class="preview-title-display" id="previewTitleDisplay"></div>
      <div class="preview-subtitle-display" id="previewSubtitleDisplay"></div>
    </div>
  </div>
</div>

<!-- Render progress -->
<div class="render-progress" id="renderProgress">
  <div class="progress-label" id="progressLabel">Preparing renderâ€¦</div>
  <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
</div>

<!-- Script -->
<div class="script-panel">
  <h3>Guided Meditation Script <span style="font-size:11px;color:var(--soft);font-style:normal;margin-left:8px;">(optional â€” shown as scrolling text)</span></h3>
  <textarea id="meditationScript" rows="4" placeholder="Optional: paste a meditation script here. It will scroll gently over the videoâ€¦&#10;&#10;Example: Close your eyes and take a slow, deep breath inâ€¦ holdâ€¦ and release. Feel your body becoming heavyâ€¦"></textarea>
  <div class="action-row" style="margin-top:12px">
    <button class="btn btn-ghost" id="generateScriptBtn">âœ¦ Auto-Generate Script</button>
    <button class="btn btn-ghost" id="clearScriptBtn">Clear</button>
  </div>
</div>

<!-- YouTube Upload -->
<div class="yt-panel">
  <h3>
    <svg width="16" height="16" viewBox="0 0 24 24" fill="#ff8080"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
    Upload to YouTube
  </h3>
  <p>Connect your Google account to upload directly. You'll need a YouTube Data API v3 key from Google Cloud Console. <a href="https://console.cloud.google.com" target="_blank" style="color:var(--lavender)">Get one here â†’</a></p>

  <div class="yt-form">
    <input type="text" id="ytApiKey" placeholder="YouTube Data API v3 Key (AIzaâ€¦)">
    <input type="text" id="ytTitle" placeholder="YouTube video title" value="10 Hours Deep Sleep Meditation Music ğŸ˜´ Relaxing Ambient">
    <textarea id="ytDesc" rows="3" placeholder="Video descriptionâ€¦">10 hours of deeply relaxing sleep meditation music to help you drift into a peaceful, restorative sleep. 
```

ğŸµ Featuring binaural beats, ambient soundscapes, and gentle visual meditations.

ğŸ’™ Subscribe for more sleep and meditation content.

#sleep #meditation #relax #sleepmusic #binauralbeats</textarea>
<input type="text" id="ytTags" placeholder="Tags (comma-separated)" value="sleep music, meditation, relaxing music, binaural beats, sleep aid, deep sleep">
<div class="control-row">
<label>Privacy</label>
<select id="ytPrivacy">
<option value="private">Private (review before publishing)</option>
<option value="unlisted">Unlisted</option>
<option value="public">Public</option>
</select>
</div>

```
    <div class="action-row">
      <button class="btn btn-ghost" id="ytAuthBtn">ğŸ” Authorize Google</button>
      <button class="btn btn-danger" id="ytUploadBtn" disabled>â¬† Upload to YouTube</button>
    </div>
    <div class="yt-status" id="ytStatus"></div>
  </div>
</div>
```

  </main>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const state = {
  scene: 'particles',
  palette: 'midnight',
  motionSpeed: 0.4,
  density: 60,
  bloom: 0.6,
  title: 'Deep Sleep Meditation',
  subtitle: '10 Hours Â· Relaxing Music for Deep Sleep',
  titleFade: 3,
  textOpacity: 0.85,
  musicSource: 'procedural',
  ambientType: 'sleep',
  baseTone: 432,
  binauralBeat: 3,
  reverbDepth: 0.7,
  warmth: 800,
  duration: 600,
  resolution: 720,
  framerate: 30,
  quality: 'medium',
  colors: { bg:'#050a1a', primary:'#8b8fd8', accent:'#4db8b8' },
  uploadedAudio: null,
  previewing: false,
  rendering: false,
  elapsedSeconds: 0,
  script: '',
  watermark: true
};

const PALETTES = {
  midnight: { bg:'#050a1a', primary:'#8b8fd8', accent:'#4db8b8', secondary:'#c07ba0' },
  aurora:   { bg:'#030d10', primary:'#00e5bb', accent:'#7b4fff', secondary:'#00b4d8' },
  dusk:     { bg:'#120818', primary:'#e8a0c0', accent:'#f4c87a', secondary:'#c97bb5' },
  forest:   { bg:'#040f08', primary:'#52c98c', accent:'#a8e6cf', secondary:'#3a9e6f' },
  custom:   null
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('previewCanvas');
const ctx = canvas.getContext('2d');
let animId = null;
let frameCount = 0;
let previewStart = null;
let particles = [];
let mandalaPts = [];
let cosmosStars = [];

function setCanvasSize() {
  const wrap = canvas.parentElement;
  canvas.width = wrap.offsetWidth;
  canvas.height = wrap.offsetHeight;
}

window.addEventListener('resize', () => { setCanvasSize(); initScene(); });
setCanvasSize();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COLOR HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getColors() {
  if (state.palette === 'custom') return state.colors;
  return PALETTES[state.palette] || PALETTES.midnight;
}

function hexToRgb(hex) {
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const b = parseInt(hex.slice(5,7),16);
  return {r,g,b};
}

function rgba(hex, a) {
  const {r,g,b} = hexToRgb(hex);
  return `rgba(${r},${g},${b},${a})`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCENE INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initScene() {
  const cols = getColors();
  const N = state.density;

  if (state.scene === 'particles' || state.scene === 'nature') {
    particles = Array.from({length: N}, (_,i) => ({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      r: Math.random() * 3 + 0.5,
      vx: (Math.random()-0.5) * 0.3,
      vy: (Math.random()-0.5) * 0.3,
      opacity: Math.random() * 0.7 + 0.1,
      pulse: Math.random() * Math.PI*2,
      hue: Math.random()
    }));
  }

  if (state.scene === 'cosmos') {
    cosmosStars = Array.from({length: N * 2}, () => ({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      r: Math.random() * 2,
      twinkle: Math.random() * Math.PI*2,
      speed: Math.random() * 0.0002 + 0.0001
    }));
    particles = Array.from({length: Math.floor(N/3)}, () => ({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      r: Math.random() * 5 + 1,
      vx: (Math.random()-0.5)*0.1,
      vy: (Math.random()-0.5)*0.1,
      opacity: Math.random()*0.4+0.05,
      hue: Math.random()
    }));
  }

  if (state.scene === 'mandala') {
    // No pre-init needed
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCENE RENDERERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawScene(t) {
  const speed = state.motionSpeed;
  const cols = getColors();
  const bloom = state.bloom;
  const W = canvas.width, H = canvas.height;

  // BG
  ctx.fillStyle = cols.bg;
  ctx.fillRect(0,0,W,H);

  // Radial center glow
  const cx = W/2, cy = H/2;
  const grd = ctx.createRadialGradient(cx,cy,0,cx,cy,Math.min(W,H)*0.7);
  grd.addColorStop(0, rgba(cols.primary, bloom*0.12));
  grd.addColorStop(0.5, rgba(cols.accent, bloom*0.04));
  grd.addColorStop(1, 'transparent');
  ctx.fillStyle = grd;
  ctx.fillRect(0,0,W,H);

  switch(state.scene) {
    case 'particles': drawParticles(t, cols, W, H); break;
    case 'mandala':   drawMandala(t, cols, W, H); break;
    case 'nature':    drawNature(t, cols, W, H); break;
    case 'cosmos':    drawCosmos(t, cols, W, H); break;
    case 'breath':    drawBreath(t, cols, W, H); break;
  }

  // Title overlay
  drawTextOverlay(t, W, H);
}

function drawParticles(t, cols, W, H) {
  const speed = state.motionSpeed;
  const bloom = state.bloom;

  // Flowing aurora bands
  for(let i=0;i<3;i++){
    const y = H*(0.3+i*0.2) + Math.sin(t*speed*0.3+i*2)*H*0.1;
    const grd = ctx.createLinearGradient(0,y-80,0,y+80);
    grd.addColorStop(0,'transparent');
    grd.addColorStop(0.5, rgba(i===0?cols.primary:i===1?cols.accent:cols.secondary||cols.primary, bloom*0.06));
    grd.addColorStop(1,'transparent');
    ctx.fillStyle = grd;
    ctx.beginPath();
    ctx.ellipse(W/2, y, W*0.8, 60+Math.sin(t*speed*0.5+i)*20, 0, 0, Math.PI*2);
    ctx.fill();
  }

  // Particles
  ctx.save();
  if(bloom > 0.3) { ctx.filter = `blur(${bloom*2}px)`; }

  particles.forEach(p => {
    p.x += p.vx * speed;
    p.y += p.vy * speed;
    p.pulse += 0.02 * speed;
    if(p.x < 0) p.x = W; if(p.x > W) p.x = 0;
    if(p.y < 0) p.y = H; if(p.y > H) p.y = 0;

    const op = p.opacity * (0.6 + 0.4 * Math.sin(p.pulse));
    const col = p.hue < 0.5 ? cols.primary : cols.accent;
    const grd = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*3);
    grd.addColorStop(0, rgba(col, op));
    grd.addColorStop(1, 'transparent');
    ctx.fillStyle = grd;
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r*3,0,Math.PI*2);
    ctx.fill();
  });

  ctx.restore();

  // Connecting lines between close particles
  ctx.save();
  ctx.strokeStyle = rgba(cols.primary, 0.04);
  ctx.lineWidth = 0.5;
  for(let i=0;i<particles.length;i++){
    for(let j=i+1;j<particles.length;j++){
      const dx=particles[i].x-particles[j].x, dy=particles[i].y-particles[j].y;
      const d=Math.sqrt(dx*dx+dy*dy);
      if(d<80){
        ctx.globalAlpha=(1-d/80)*0.15*state.bloom;
        ctx.beginPath();
        ctx.moveTo(particles[i].x,particles[i].y);
        ctx.lineTo(particles[j].x,particles[j].y);
        ctx.stroke();
      }
    }
  }
  ctx.globalAlpha=1;
  ctx.restore();
}

function drawMandala(t, cols, W, H) {
  const speed = state.motionSpeed;
  const cx=W/2, cy=H/2;
  const bloom = state.bloom;
  const N = Math.max(4, Math.floor(state.density/10));

  ctx.save();
  ctx.translate(cx, cy);

  // Outer rings
  for(let ring=1;ring<=4;ring++){
    const R = ring * Math.min(W,H)*0.08;
    const sides = N * ring;
    const rot = t * speed * 0.1 * (ring%2===0?1:-1);
    ctx.save();
    ctx.rotate(rot);
    ctx.strokeStyle = rgba(ring%2===0?cols.primary:cols.accent, bloom*0.4/ring);
    ctx.lineWidth = bloom * 1.5;
    ctx.beginPath();
    for(let i=0;i<sides;i++){
      const a = (i/sides)*Math.PI*2;
      const r2 = R*(0.9+0.1*Math.sin(a*3+t*speed*0.5));
      if(i===0) ctx.moveTo(Math.cos(a)*r2, Math.sin(a)*r2);
      else ctx.lineTo(Math.cos(a)*r2, Math.sin(a)*r2);
    }
    ctx.closePath();
    ctx.stroke();
    ctx.restore();
  }

  // Petal layer
  const petalR = Math.min(W,H)*0.2;
  for(let p=0;p<N;p++){
    const a = (p/N)*Math.PI*2 + t*speed*0.05;
    ctx.save();
    ctx.rotate(a);
    ctx.globalAlpha = bloom*0.3;
    const grd = ctx.createRadialGradient(petalR,0,0,petalR,0,petalR*0.6);
    grd.addColorStop(0, cols.primary);
    grd.addColorStop(1,'transparent');
    ctx.fillStyle = grd;
    ctx.beginPath();
    ctx.arc(petalR,0,petalR*0.5,0,Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  // Center bloom
  const cR = Math.min(W,H)*0.07;
  const cgrd = ctx.createRadialGradient(0,0,0,0,0,cR);
  cgrd.addColorStop(0, rgba(cols.accent,bloom*0.8));
  cgrd.addColorStop(1,'transparent');
  ctx.fillStyle=cgrd;
  ctx.beginPath();
  ctx.arc(0,0,cR,0,Math.PI*2);
  ctx.fill();

  ctx.restore();
}

function drawNature(t, cols, W, H) {
  const speed = state.motionSpeed;
  const bloom = state.bloom;

  // Layered flowing waves (water / gentle)
  for(let layer=0;layer<6;layer++){
    const y0 = H*0.4 + layer*H*0.1;
    const amp = 20+layer*8;
    const freq = 0.005+layer*0.002;
    const phase = t*speed*(0.3+layer*0.1);
    const op = bloom*(0.06 - layer*0.008);

    ctx.strokeStyle = rgba(layer%2===0?cols.primary:cols.accent, Math.max(0,op));
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    for(let x=0;x<=W;x+=4){
      const y = y0 + Math.sin(x*freq+phase)*amp + Math.sin(x*freq*2.3+phase*1.5)*amp*0.3;
      x===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    }
    ctx.stroke();
  }

  // Slow floating orbs
  drawParticles(t, cols, W, H);

  // Vignette
  const vgrd = ctx.createRadialGradient(W/2,H/2,H*0.3,W/2,H/2,H*0.9);
  vgrd.addColorStop(0,'transparent');
  vgrd.addColorStop(1,rgba(cols.bg,0.5));
  ctx.fillStyle=vgrd;
  ctx.fillRect(0,0,W,H);
}

function drawCosmos(t, cols, W, H) {
  const speed = state.motionSpeed;
  const bloom = state.bloom;

  // Stars
  cosmosStars.forEach(s => {
    s.twinkle += s.speed * speed * 50;
    const op = 0.3 + 0.7*(0.5+0.5*Math.sin(s.twinkle));
    ctx.fillStyle = rgba('#ffffff', op*0.8);
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
    ctx.fill();
  });

  // Nebula clouds
  particles.forEach(p => {
    p.x += p.vx * speed * 0.3;
    p.y += p.vy * speed * 0.3;
    if(p.x < -p.r*10) p.x = W+p.r*10;
    if(p.x > W+p.r*10) p.x = -p.r*10;
    if(p.y < -p.r*10) p.y = H+p.r*10;
    if(p.y > H+p.r*10) p.y = -p.r*10;

    const col = p.hue<0.33?cols.primary:p.hue<0.66?cols.accent:cols.secondary||cols.primary;
    if(bloom>0.3){
      ctx.save(); ctx.filter=`blur(${p.r*2}px)`;
      ctx.fillStyle = rgba(col, p.opacity*bloom);
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r*4,0,Math.PI*2); ctx.fill();
      ctx.restore();
    }
  });
}

function drawBreath(t, cols, W, H) {
  const speed = state.motionSpeed;
  const bloom = state.bloom;
  const cx=W/2, cy=H/2;
  const cycleLen = 8/speed; // seconds-ish
  const phase = (t%(cycleLen))/(cycleLen);
  // inhale 0-0.4, hold 0.4-0.6, exhale 0.6-1
  let scale;
  if(phase<0.4) scale = phase/0.4; // 0â†’1
  else if(phase<0.6) scale = 1;
  else scale = 1-(phase-0.6)/0.4; // 1â†’0
  scale = 0.3 + scale*0.7;

  const baseR = Math.min(W,H)*0.22;
  const R = baseR*scale;

  // Rings
  for(let ring=5;ring>=1;ring--){
    const rr = R*(ring/3);
    const grd = ctx.createRadialGradient(cx,cy,0,cx,cy,rr);
    grd.addColorStop(0, rgba(cols.primary, bloom*0.15/ring));
    grd.addColorStop(1,'transparent');
    ctx.fillStyle=grd;
    ctx.beginPath(); ctx.arc(cx,cy,rr,0,Math.PI*2); ctx.fill();
  }

  // Outer ring stroke
  ctx.strokeStyle = rgba(cols.accent, bloom*0.7);
  ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.stroke();

  // Breath text
  const breathText = phase<0.4?'inhale':phase<0.6?'hold':'exhale';
  ctx.save();
  ctx.fillStyle = rgba(cols.primary, 0.6*bloom);
  ctx.font = `${Math.floor(W*0.025)}px 'Cormorant Garamond', serif`;
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(breathText, cx, cy+R+20);
  ctx.restore();

  // Also draw soft particles
  drawParticles(t, cols, W, H);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEXT OVERLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawTextOverlay(t, W, H) {
  // Watermark
  if (state.watermark) {
    ctx.save();
    ctx.globalAlpha = 0.38;
    ctx.font = `${Math.max(8, W*0.009)}px 'Jost', sans-serif`;
    ctx.textAlign = 'right';
    ctx.textBaseline = 'top';
    ctx.fillStyle = '#ffffff';
    ctx.shadowColor = 'rgba(0,0,0,0.8)';
    ctx.shadowBlur = 8;
    // Small coffee cup icon + text
    ctx.fillText('â˜• Made with Serenity Studio', W - 12, 12);
    ctx.restore();
  }

  if(!state.title && !state.subtitle) return;
  const fadeStart = state.titleFade;
  const fadeLen = 2;
  const alpha = t < fadeStart ? 0 : t < fadeStart+fadeLen ? (t-fadeStart)/fadeLen : 1;
  const textAlpha = alpha * state.textOpacity;
  if(textAlpha <= 0) return;

  const paddingBottom = H*0.06;
  const cols = getColors();

  // Title
  ctx.save();
  ctx.globalAlpha = textAlpha;
  const titleSize = Math.max(16, W*0.028);
  ctx.font = `italic ${titleSize}px 'Cormorant Garamond', serif`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'bottom';

  // Text shadow
  ctx.shadowColor = rgba(cols.bg, 0.9);
  ctx.shadowBlur = 20;
  ctx.fillStyle = '#e8dfc8';
  ctx.fillText(state.title, W/2, H - paddingBottom - 20);

  // Subtitle
  ctx.font = `${Math.max(9, W*0.011)}px 'Jost', sans-serif`;
  ctx.letterSpacing = '2px';
  ctx.fillStyle = rgba('#ffffff', 0.5);
  ctx.shadowBlur = 10;
  ctx.fillText(state.subtitle.toUpperCase(), W/2, H - paddingBottom);

  ctx.restore();

  // Scrolling script
  if(state.script && t > fadeStart + 5) {
    const scrollSpeed = 20; // chars per minute ish
    const charIdx = Math.floor((t - fadeStart - 5) * 1.5) % (state.script.length + 100);
    const visible = state.script.slice(Math.max(0,charIdx-80), charIdx);
    ctx.save();
    ctx.globalAlpha = textAlpha * 0.55;
    ctx.font = `italic ${Math.max(10, W*0.014)}px 'Cormorant Garamond', serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    ctx.fillStyle = '#c8d4e8';
    ctx.shadowColor = rgba(cols.bg,0.9); ctx.shadowBlur=15;
    ctx.fillText(visible, W/2, H*0.12);
    ctx.restore();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANIMATION LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let t = 0;
function animLoop(ts) {
  if(!previewStart) previewStart = ts;
  t = (ts - previewStart) / 1000 * state.motionSpeed * 2;
  frameCount++;

  drawScene(t);

  // Timer UI
  const secs = Math.floor((ts - previewStart)/1000);
  state.elapsedSeconds = secs;
  document.getElementById('previewTimer').textContent =
    String(Math.floor(secs/60)).padStart(2,'0') + ':' + String(secs%60).padStart(2,'0');

  // Preview title in overlay DOM
  document.getElementById('previewTitleDisplay').textContent = state.title;
  document.getElementById('previewSubtitleDisplay').textContent = state.subtitle;

  animId = requestAnimationFrame(animLoop);
}

function startPreview() {
  if(animId) { cancelAnimationFrame(animId); animId=null; }
  previewStart = null; frameCount = 0; t = 0;
  initScene();
  animId = requestAnimationFrame(animLoop);
  document.getElementById('previewBtn').textContent = 'â¹ Stop';
  state.previewing = true;
}

function stopPreview() {
  if(animId) { cancelAnimationFrame(animId); animId=null; }
  document.getElementById('previewBtn').textContent = 'â–¶ Preview';
  state.previewing = false;
  previewStart = null;
}

// Auto-start preview
startPreview();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEB AUDIO ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let audioCtx = null;
let testNodes = [];

function getAudioCtx() {
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

function stopTestNodes() {
  testNodes.forEach(n => { try{n.stop&&n.stop(); n.disconnect&&n.disconnect();}catch(e){} });
  testNodes = [];
}

function buildProceduralAudio(ctx, duration) {
  const nodes = [];
  const master = ctx.createGain();
  master.gain.setValueAtTime(0, ctx.currentTime);
  master.gain.linearRampToValueAtTime(0.5, ctx.currentTime + Math.min(state.fadeIn||5, duration*0.1));
  master.gain.setValueAtTime(0.5, ctx.currentTime + duration - Math.min(state.fadeOut||10, duration*0.1));
  master.gain.linearRampToValueAtTime(0, ctx.currentTime + duration);
  master.connect(ctx.destination);

  // Low-pass filter for warmth
  const lp = ctx.createBiquadFilter();
  lp.type='lowpass'; lp.frequency.value = state.warmth;
  lp.Q.value = 0.5;
  lp.connect(master);

  // Reverb via convolver
  const convolver = ctx.createConvolver();
  const revLen = Math.max(0.1, state.reverbDepth * 4);
  const revBuf = ctx.createBuffer(2, ctx.sampleRate*revLen, ctx.sampleRate);
  for(let ch=0;ch<2;ch++){
    const d = revBuf.getChannelData(ch);
    for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,2);
  }
  convolver.buffer = revBuf;
  convolver.connect(lp);

  const dryWet = ctx.createGain();
  dryWet.gain.value = state.reverbDepth * 0.6;
  const dry = ctx.createGain();
  dry.gain.value = 1 - state.reverbDepth*0.4;

  const srcBus = ctx.createGain();
  srcBus.connect(convolver);
  srcBus.connect(dry);
  dry.connect(lp);

  function addOsc(freq, type='sine', gain=0.08, detune=0) {
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = type;
    o.frequency.value = freq;
    o.detune.value = detune;
    g.gain.value = gain;
    o.connect(g); g.connect(srcBus);
    o.start(ctx.currentTime);
    o.stop(ctx.currentTime + duration + 0.1);
    nodes.push(o);
  }

  const base = state.baseTone;
  const beat = state.binauralBeat;

  switch(state.ambientType) {
    case 'sleep':
      // Delta waves ~2Hz
      addOsc(base, 'sine', 0.12);
      addOsc(base + 2, 'sine', 0.12); // binaural delta
      addOsc(base*0.5, 'sine', 0.08); // sub octave
      addOsc(base*2, 'sine', 0.04);
      addOsc(base*3, 'sine', 0.02);
      break;
    case 'theta':
      addOsc(base, 'sine', 0.1);
      addOsc(base + beat, 'sine', 0.1);
      addOsc(base*1.5, 'sine', 0.05);
      addOsc(base/2, 'sine', 0.07);
      break;
    case 'binauralAlpha':
      addOsc(base, 'sine', 0.1);
      addOsc(base + 10, 'sine', 0.1);
      addOsc(base*2, 'sine', 0.04);
      addOsc(base*3, 'sine', 0.02);
      break;
    case '528hz':
      addOsc(528, 'sine', 0.12);
      addOsc(528 + beat, 'sine', 0.08);
      addOsc(528*2, 'sine', 0.04);
      addOsc(396, 'sine', 0.05);
      break;
    case 'rain': {
      // Noise via buffer
      const noiseLen = 2;
      const noiseBuf = ctx.createBuffer(1, ctx.sampleRate*noiseLen, ctx.sampleRate);
      const nd = noiseBuf.getChannelData(0);
      for(let i=0;i<nd.length;i++) nd[i]=Math.random()*2-1;
      const noise = ctx.createBufferSource();
      noise.buffer = noiseBuf; noise.loop = true;
      const nlp = ctx.createBiquadFilter(); nlp.type='lowpass'; nlp.frequency.value=500;
      const ng = ctx.createGain(); ng.gain.value=0.15;
      noise.connect(nlp); nlp.connect(ng); ng.connect(srcBus);
      noise.start(); noise.stop(ctx.currentTime+duration+0.1);
      nodes.push(noise);
      addOsc(60,'sine',0.05);
      break;
    }
    case 'bowl':
      addOsc(base, 'sine', 0.15);
      addOsc(base*2.756, 'sine', 0.06); // tibetan bowl partials
      addOsc(base*5.05, 'sine', 0.03);
      addOsc(base + beat, 'sine', 0.08);
      break;
  }

  nodes.push(master, lp, convolver, srcBus, dry);
  return nodes;
}

document.getElementById('testAudioBtn').addEventListener('click', async () => {
  stopTestNodes();
  const ac = getAudioCtx();
  if(ac.state==='suspended') await ac.resume();
  const nodes = buildProceduralAudio(ac, 10);
  testNodes = nodes;
  document.getElementById('testAudioBtn').textContent = 'â¹ Playingâ€¦ (10s)';
  setTimeout(() => {
    stopTestNodes();
    document.getElementById('testAudioBtn').textContent = 'â–¶ Test Audio (10s)';
  }, 11000);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCRIPT GENERATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SCRIPTS = [
  `Close your eyes and allow your breath to slow. With each exhale, feel the weight of the world release from your shoulders. You are safe. You are held. Let your thoughts drift like clouds across a vast, moonlit sky. There is nowhere you need to be, nothing you need to do. Simply rest. Feel the warmth of peace spreading through your chest, down through your arms, into your hands. Your body is growing heavy, deliciously heavy. Each breath carries you deeper into stillness. Deeper into calm. You are drifting now, softly, into the most restorative sleepâ€¦`,
  `Imagine yourself lying on the softest moss, beneath a canopy of ancient stars. A warm breeze moves gently across your face. With each breath in, breathe in golden light. With each breath out, release any tension, any worry, any thought. Your mind is quieting. The stars above you pulse with a gentle rhythm, matching the rhythm of your heart. You are one with the silence. One with the peace. Let sleep come to you now, like a gentle tide, slowly, surely, washing over youâ€¦`,
  `Begin by noticing your breath. Don't change it â€” just observe. Inâ€¦ and out. Feel how your chest rises and falls with perfect ease. Your body knows exactly how to breathe, exactly how to rest. You don't have to try. Simply allow. Allow your eyes to remain closed. Allow your muscles to soften. Allow sleep to find you. It is already here, already within you. A deep, nourishing, healing sleep. Your nervous system is calming. Your heart is slowing. You are drifting now into the deepest restâ€¦`
];

document.getElementById('generateScriptBtn').addEventListener('click', () => {
  document.getElementById('meditationScript').value = SCRIPTS[Math.floor(Math.random()*SCRIPTS.length)];
  state.script = document.getElementById('meditationScript').value;
});

document.getElementById('clearScriptBtn').addEventListener('click', () => {
  document.getElementById('meditationScript').value = '';
  state.script = '';
});

document.getElementById('meditationScript').addEventListener('input', e => { state.script = e.target.value; });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER VIDEO (MediaRecorder)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('renderBtn').addEventListener('click', renderVideo);

async function renderVideo() {
  if(state.rendering) return;
  state.rendering = true;
  stopPreview();

  const renderDuration = state.duration;
  const fps = state.framerate;

  // Resize canvas to target resolution
  const resMap = {480:[854,480], 720:[1280,720], 1080:[1920,1080]};
  const [rW, rH] = resMap[state.resolution] || [1280,720];
  canvas.width = rW; canvas.height = rH;
  initScene();

  // Show progress
  const prog = document.getElementById('renderProgress');
  const fill = document.getElementById('progressFill');
  const label = document.getElementById('progressLabel');
  prog.classList.add('visible');
  document.getElementById('recBadge').classList.add('visible');
  document.getElementById('renderBtn').disabled = true;

  // Stream from canvas
  const stream = canvas.captureStream(fps);

  // Audio stream (procedural)
  let audioStream = null;
  let audioNodes = [];
  if(state.musicSource === 'procedural') {
    try {
      const ac = new AudioContext();
      const dest = ac.createMediaStreamDestination();
      const nodes = buildProceduralAudio(ac, renderDuration);
      // Connect master to dest instead of ctx.destination
      nodes[0].disconnect && nodes[0].disconnect();
      nodes[0].connect(dest);
      audioStream = dest.stream;
      audioNodes = nodes;
    } catch(e) { console.warn('Audio stream failed:', e); }
  } else if(state.uploadedAudio && state.musicSource === 'upload') {
    try {
      const ac = new AudioContext();
      const ab = await state.uploadedAudio.arrayBuffer();
      const decoded = await ac.decodeAudioData(ab);
      const src = ac.createBufferSource();
      src.buffer = decoded; src.loop = true;
      const dest = ac.createMediaStreamDestination();
      const gain = ac.createGain();
      gain.gain.value = parseFloat(document.getElementById('uploadVol').value) || 0.8;
      src.connect(gain); gain.connect(dest);
      src.start();
      audioStream = dest.stream;
      audioNodes = [src, gain];
    } catch(e) { console.warn('Upload audio stream failed:', e); }
  }

  // Combine streams
  const tracks = [...stream.getVideoTracks()];
  if(audioStream) tracks.push(...audioStream.getAudioTracks());
  const combined = new MediaStream(tracks);

  const qualMap = {high:8000000, medium:4000000, fast:1500000};
  const bitsPerSec = qualMap[state.quality] || 4000000;

  let mimeType = 'video/webm;codecs=vp9,opus';
  if(!MediaRecorder.isTypeSupported(mimeType)) mimeType = 'video/webm;codecs=vp8,opus';
  if(!MediaRecorder.isTypeSupported(mimeType)) mimeType = 'video/webm';

  const recorder = new MediaRecorder(combined, { mimeType, videoBitsPerSecond: bitsPerSec });
  const chunks = [];
  recorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };

  recorder.onstop = () => {
    const blob = new Blob(chunks, {type:'video/webm'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = (state.title || 'meditation').replace(/[^a-z0-9]/gi,'_') + '.webm';
    a.click();
    URL.revokeObjectURL(url);

    // Restore
    setCanvasSize(); initScene(); startPreview();
    prog.classList.remove('visible');
    document.getElementById('recBadge').classList.remove('visible');
    document.getElementById('renderBtn').disabled = false;
    state.rendering = false;
    label.textContent = 'Render complete!';
    setTimeout(()=>prog.classList.remove('visible'),3000);

    // Store blob for YouTube
    state.renderedBlob = blob;
    document.getElementById('ytUploadBtn').disabled = !state.ytAccessToken;
  };

  recorder.start(1000); // collect every second

  // Render frames
  const startMs = performance.now();
  const totalFrames = renderDuration * fps;
  let f = 0;
  previewStart = null; t = 0;

  function renderFrame(ts) {
    if(!previewStart) previewStart = ts;
    t = (ts - previewStart) / 1000 * state.motionSpeed * 2;
    drawScene(t);
    f++;
    const elapsed = (performance.now()-startMs)/1000;
    const pct = Math.min(100, (elapsed/renderDuration)*100);
    fill.style.width = pct+'%';
    const rem = Math.max(0, renderDuration - elapsed);
    label.textContent = `Renderingâ€¦ ${pct.toFixed(0)}% Â· ${formatTime(rem)} remaining`;

    // For 1-minute videos render in real-time; for longer, we stop after 60s render time
    const maxRenderTime = Math.min(renderDuration, 90); // cap preview render at 90 real-seconds
    if(elapsed < maxRenderTime && state.rendering) {
      animId = requestAnimationFrame(renderFrame);
    } else {
      recorder.stop();
      audioNodes.forEach(n=>{try{n.stop&&n.stop();}catch(e){}});
    }
  }

  animId = requestAnimationFrame(renderFrame);
}

function formatTime(s) {
  const m = Math.floor(s/60), sec = Math.floor(s%60);
  return `${m}:${String(sec).padStart(2,'0')}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// YOUTUBE OAUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
state.ytAccessToken = null;

document.getElementById('ytAuthBtn').addEventListener('click', () => {
  const apiKey = document.getElementById('ytApiKey').value.trim();
  if(!apiKey) {
    setYtStatus('error', 'Please enter your YouTube Data API v3 key first. You also need OAuth2 Client ID for upload.');
    return;
  }
  // YouTube upload requires OAuth2. We'll use a popup flow with the user's own client ID.
  const clientId = prompt('Enter your Google OAuth2 Client ID (from Google Cloud Console):');
  if(!clientId) return;

  const scope = 'https://www.googleapis.com/auth/youtube.upload';
  const redirectUri = window.location.href.split('?')[0];
  const oauthUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${encodeURIComponent(clientId)}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=${encodeURIComponent(scope)}`;

  const popup = window.open(oauthUrl, 'ytAuth', 'width=500,height=600');
  const poll = setInterval(() => {
    try {
      const hash = popup?.location?.hash;
      if(hash && hash.includes('access_token')) {
        clearInterval(poll);
        popup.close();
        const params = new URLSearchParams(hash.slice(1));
        state.ytAccessToken = params.get('access_token');
        setYtStatus('success', 'âœ“ Authorized! Click "Upload to YouTube" after rendering.');
        document.getElementById('ytUploadBtn').disabled = !state.renderedBlob;
        document.getElementById('ytAuthBtn').textContent = 'âœ“ Authorized';
      }
    } catch(e) {}
  }, 500);
});

document.getElementById('ytUploadBtn').addEventListener('click', uploadToYouTube);

async function uploadToYouTube() {
  if(!state.renderedBlob) { setYtStatus('error','Please render the video first.'); return; }
  if(!state.ytAccessToken) { setYtStatus('error','Please authorize with Google first.'); return; }

  setYtStatus('info','Uploading to YouTubeâ€¦ this may take a while for large files.');
  document.getElementById('ytUploadBtn').disabled = true;

  const meta = {
    snippet: {
      title: document.getElementById('ytTitle').value,
      description: document.getElementById('ytDesc').value,
      tags: document.getElementById('ytTags').value.split(',').map(s=>s.trim()),
      categoryId: '22'
    },
    status: { privacyStatus: document.getElementById('ytPrivacy').value }
  };

  const form = new FormData();
  form.append('metadata', new Blob([JSON.stringify(meta)],{type:'application/json'}));
  form.append('file', state.renderedBlob, 'meditation.webm');

  try {
    const res = await fetch('https://www.googleapis.com/upload/youtube/v3/videos?part=snippet,status&uploadType=multipart', {
      method:'POST',
      headers:{ Authorization:`Bearer ${state.ytAccessToken}` },
      body: form
    });

    if(!res.ok) {
      const err = await res.json();
      throw new Error(err?.error?.message || 'Upload failed');
    }
    const data = await res.json();
    setYtStatus('success', `âœ“ Uploaded! Video ID: ${data.id} Â· <a href="https://youtube.com/watch?v=${data.id}" target="_blank" style="color:var(--teal)">View on YouTube â†’</a>`);
  } catch(e) {
    setYtStatus('error', 'âœ— Upload error: ' + e.message);
    document.getElementById('ytUploadBtn').disabled = false;
  }
}

function setYtStatus(type, msg) {
  const el = document.getElementById('ytStatus');
  el.className = 'yt-status ' + type;
  el.innerHTML = msg;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('audioUpload').addEventListener('change', e => {
  const file = e.target.files[0];
  if(!file) return;
  state.uploadedAudio = file;
  document.getElementById('uploadedFileName').textContent = file.name;
  document.getElementById('uploadedFile').classList.add('visible');
});

const dz = document.getElementById('dropZone');
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
dz.addEventListener('drop', e => {
  e.preventDefault(); dz.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if(file && file.type.startsWith('audio/')) {
    state.uploadedAudio = file;
    document.getElementById('uploadedFileName').textContent = file.name;
    document.getElementById('uploadedFile').classList.add('visible');
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI WIRING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function bindRange(id, stateKey, displayId, transform) {
  const el = document.getElementById(id);
  const disp = document.getElementById(displayId);
  el.addEventListener('input', () => {
    const val = transform ? transform(el.value) : parseFloat(el.value);
    state[stateKey] = val;
    if(disp) disp.textContent = val;
  });
}

bindRange('motionSpeed','motionSpeed','speedVal',parseFloat);
bindRange('density','density','densityVal',parseFloat);
bindRange('bloom','bloom','bloomVal',parseFloat);
bindRange('titleFade','titleFade','titleFadeVal',parseFloat);
bindRange('textOpacity','textOpacity','textOpacityVal',parseFloat);
bindRange('baseTone','baseTone','baseToneVal',parseFloat);
bindRange('binauralBeat','binauralBeat','binauralVal',parseFloat);
bindRange('reverbDepth','reverbDepth','reverbVal',parseFloat);
bindRange('warmth','warmth','warmthVal',parseFloat);
bindRange('fadeIn','fadeIn','fadeInVal',parseFloat);
bindRange('fadeOut','fadeOut','fadeOutVal',parseFloat);
bindRange('uploadVol',null,'uploadVolVal',parseFloat);

document.getElementById('videoTitle').addEventListener('input', e => {
  state.title = e.target.value;
  document.getElementById('previewTitleDisplay').textContent = state.title;
});
document.getElementById('videoSubtitle').addEventListener('input', e => {
  state.subtitle = e.target.value;
  document.getElementById('previewSubtitleDisplay').textContent = state.subtitle;
});

document.getElementById('sceneStyle').addEventListener('change', e => {
  state.scene = e.target.value;
  document.getElementById('infoScene').textContent = e.target.options[e.target.selectedIndex].text.replace(/[^a-zA-Z\s&/]/g,'').trim();
  initScene();
});

document.getElementById('ambientType').addEventListener('change', e => { state.ambientType = e.target.value; });

document.getElementById('resolution').addEventListener('change', e => {
  state.resolution = parseInt(e.target.value);
  document.getElementById('infoRes').textContent = e.target.value+'p';
});

document.getElementById('framerate').addEventListener('change', e => { state.framerate = parseInt(e.target.value); });
document.getElementById('quality').addEventListener('change', e => { state.quality = e.target.value; });

// Watermark toggle
document.getElementById('watermarkToggle').addEventListener('change', e => {
  state.watermark = e.target.checked;
});

// Ko-fi â€” update href to user's real Ko-fi page
// Replace 'yourname' with your actual Ko-fi username after publishing
document.getElementById('kofiBtn').href = 'https://ko-fi.com/yourname';

// Palette group
document.querySelectorAll('#paletteGroup .toggle-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#paletteGroup .toggle-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    state.palette = btn.dataset.palette;
    document.getElementById('customColors').style.display = state.palette==='custom'?'block':'none';
    initScene();
  });
});

// Custom colors
['colorBg','colorPrimary','colorAccent'].forEach(id => {
  document.getElementById(id).addEventListener('input', e => {
    const key = id==='colorBg'?'bg':id==='colorPrimary'?'primary':'accent';
    state.colors[key] = e.target.value;
  });
});

// Music source toggle
document.querySelectorAll('#musicSourceGroup .toggle-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#musicSourceGroup .toggle-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    state.musicSource = btn.dataset.source;
    document.getElementById('proceduralPanel').style.display = state.musicSource==='procedural'?'block':'none';
    document.getElementById('uploadPanel').style.display = state.musicSource==='upload'?'block':'none';
  });
});

// Duration group
document.querySelectorAll('#durationGroup .toggle-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#durationGroup .toggle-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    state.duration = parseInt(btn.dataset.dur);
    const labels = {60:'1m',600:'10m',3600:'1h',36000:'10h'};
    document.getElementById('infoDuration').textContent = labels[state.duration]||btn.textContent;
  });
});

// Preview / Stop button
document.getElementById('previewBtn').addEventListener('click', () => {
  if(state.previewing) stopPreview();
  else startPreview();
});

// Initial scene
initScene();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PWA â€” MANIFEST + SERVICE WORKER + INSTALL PROMPT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Inline manifest as a blob so no external file is needed
const manifest = {
  name: "Serenity Studio",
  short_name: "Serenity",
  description: "Meditation video generator with ambient music and stunning visuals",
  start_url: "./",
  display: "standalone",
  orientation: "landscape",
  background_color: "#0d0e14",
  theme_color: "#0d0e14",
  categories: ["lifestyle", "health", "entertainment"],
  icons: [
    {
      src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='80' fill='%230d0e14'/%3E%3Ccircle cx='256' cy='256' r='140' fill='none' stroke='%238b8fd8' stroke-width='8' opacity='0.6'/%3E%3Ccircle cx='256' cy='256' r='90' fill='none' stroke='%234db8b8' stroke-width='5' opacity='0.5'/%3E%3Ccircle cx='256' cy='256' r='45' fill='%238b8fd8' opacity='0.7'/%3E%3C/svg%3E",
      sizes: "512x512",
      type: "image/svg+xml",
      purpose: "any maskable"
    }
  ],
  screenshots: [],
  shortcuts: [
    { name: "New Meditation", short_name: "New", url: "./?new=1", description: "Start a new meditation video" }
  ]
};

const manifestBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
const manifestUrl = URL.createObjectURL(manifestBlob);
document.getElementById('manifestLink').href = manifestUrl;

// â”€â”€ Service Worker (inline via blob) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const swCode = `
const CACHE = 'serenity-v1';
const ASSETS = ['/'];

self.addEventListener('install', e => {
  e.waitUntil(caches.open(CACHE).then(c => c.addAll(ASSETS)).catch(()=>{}));
  self.skipWaiting();
});

self.addEventListener('activate', e => {
  e.waitUntil(caches.keys().then(keys =>
    Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))
  ));
  self.clients.claim();
});

self.addEventListener('fetch', e => {
  e.respondWith(
    fetch(e.request).catch(() => caches.match(e.request))
  );
});
`;

if ('serviceWorker' in navigator) {
  const swBlob = new Blob([swCode], {type:'application/javascript'});
  const swUrl = URL.createObjectURL(swBlob);
  navigator.serviceWorker.register(swUrl, {scope: './'})
    .then(() => console.log('Serenity Studio: Service worker registered'))
    .catch(e => console.warn('SW registration failed (expected in file:// context):', e));
}

// â”€â”€ Install Prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let deferredInstallPrompt = null;
const installBtn = document.getElementById('installBtn');

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredInstallPrompt = e;
  installBtn.style.display = 'inline-flex';
  installBtn.animate([{opacity:0,transform:'translateY(-4px)'},{opacity:1,transform:'translateY(0)'}], {duration:400,fill:'forwards'});
});

installBtn.addEventListener('click', async () => {
  if (!deferredInstallPrompt) {
    // Fallback instructions for browsers that don't fire beforeinstallprompt (Safari)
    showInstallInstructions();
    return;
  }
  deferredInstallPrompt.prompt();
  const { outcome } = await deferredInstallPrompt.userChoice;
  if (outcome === 'accepted') {
    installBtn.style.display = 'none';
    deferredInstallPrompt = null;
  }
});

window.addEventListener('appinstalled', () => {
  installBtn.style.display = 'none';
  console.log('Serenity Studio installed!');
});

function showInstallInstructions() {
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const modal = document.createElement('div');
  modal.style.cssText = `
    position:fixed; inset:0; z-index:10000; display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,0.75); backdrop-filter:blur(10px); padding:20px;
  `;
  modal.innerHTML = `
    <div style="background:#1c2030; border:1px solid #252a3d; border-radius:16px; padding:32px; max-width:400px; width:100%; font-family:'Jost',sans-serif; color:#cdd3f0;">
      <div style="font-family:'Cormorant Garamond',serif; font-size:22px; font-style:italic; color:#e8dfc8; margin-bottom:6px;">Install Serenity Studio</div>
      <div style="font-size:10px; letter-spacing:3px; text-transform:uppercase; color:#7b83a8; margin-bottom:20px;">Add to Home Screen</div>
      ${isIOS ? `
        <div style="font-size:13px; line-height:1.8; color:#cdd3f0;">
          <p style="margin-bottom:12px;">On iPhone / iPad:</p>
          <ol style="padding-left:18px; display:flex; flex-direction:column; gap:8px;">
            <li>Tap the <strong style="color:#8b8fd8;">Share</strong> button <span style="font-size:16px;">â‹</span> in Safari's toolbar</li>
            <li>Scroll down and tap <strong style="color:#8b8fd8;">"Add to Home Screen"</strong></li>
            <li>Tap <strong style="color:#8b8fd8;">Add</strong> â€” done!</li>
          </ol>
          <p style="margin-top:14px; font-size:11px; color:#7b83a8;">The app will appear on your home screen like any native app.</p>
        </div>
      ` : `
        <div style="font-size:13px; line-height:1.8; color:#cdd3f0;">
          <p style="margin-bottom:12px;">In Chrome / Edge / Brave:</p>
          <ol style="padding-left:18px; display:flex; flex-direction:column; gap:8px;">
            <li>Click the <strong style="color:#8b8fd8;">â‹® menu</strong> (three dots) in the top-right</li>
            <li>Click <strong style="color:#8b8fd8;">"Install Serenity Studio"</strong> or <strong style="color:#8b8fd8;">"Add to Home Screen"</strong></li>
            <li>Click <strong style="color:#8b8fd8;">Install</strong> â€” done!</li>
          </ol>
          <p style="margin-top:14px; font-size:11px; color:#7b83a8;">The app will open in its own window, just like a native desktop app.</p>
        </div>
      `}
      <button onclick="this.closest('div[style]').remove()" style="
        margin-top:20px; width:100%; padding:10px; border-radius:8px;
        background:linear-gradient(135deg,#8b8fd8,#6d72c9); border:none;
        color:#fff; font-family:'Jost',sans-serif; font-size:11px;
        letter-spacing:1.5px; text-transform:uppercase; cursor:pointer;
      ">Got it</button>
    </div>
  `;
  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if(e.target===modal) modal.remove(); });
}

// Show install button anyway for Safari users (who won't get beforeinstallprompt)
if (/iphone|ipad|ipod/i.test(navigator.userAgent) && !navigator.standalone) {
  setTimeout(() => { installBtn.style.display = 'inline-flex'; }, 2000);
}
</script>
